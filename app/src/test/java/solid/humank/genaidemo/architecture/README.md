# DDD 架構測試

本目錄包含使用 ArchUnit 實現的架構測試，用於確保專案遵循領域驅動設計 (DDD) 的最佳實踐。

## 測試類別說明

### 1. DddArchitectureTest

確保專案遵循 DDD 分層架構的設計原則，包括：

- 領域層 (Domain Layer)：包含業務邏輯和規則的核心層
- 應用層 (Application Layer)：協調領域對象完成用戶的實際任務
- 基礎設施層 (Infrastructure Layer)：提供技術能力支持其他層
- 介面層 (Interface Layer)：負責向用戶或外部系統展示信息並接收輸入

這些測試確保各層之間的依賴關係符合 DDD 的原則：外層可以依賴內層，但內層不能依賴外層。

### 2. DddTacticalPatternsTest

確保正確實現 DDD 戰術模式，包括：

- 值對象 (Value Objects)：應該是不可變的
- 實體 (Entities)：應該有唯一標識
- 聚合根 (Aggregate Roots)：應該控制其內部實體的訪問
- 領域事件 (Domain Events)：應該是不可變的
- 儲存庫 (Repositories)：應該操作聚合根
- 工廠 (Factories)：應該創建聚合或複雜值對象
- 領域服務 (Domain Services)：應該是無狀態的
- 規格 (Specifications)：應該實現 Specification 接口
- 防腐層 (Anti-corruption Layer)：應該隔離外部系統

### 3. PackageStructureTest

確保專案的包結構符合 DDD 最佳實踐，包括：

- 領域模型應該組織在正確的包結構中
- 應用層應該組織在正確的包結構中
- 基礎設施層應該組織在正確的包結構中
- 介面層應該組織在正確的包結構中

## 如何運行測試

使用 Gradle 運行測試：

```bash
./gradlew test --tests "solid.humank.genaidemo.architecture.*"
```

## 如何解讀測試結果

如果測試失敗，錯誤訊息會指出哪些類別違反了架構規則

## 如何修復架構違規

1. **識別問題**：理解錯誤訊息中指出的具體違規。
2. **分析依賴**：確定為什麼會有這種依賴關係。
3. **重構代碼**：
   - 如果內層依賴外層，考慮使用依賴倒置原則。
   - 如果類別位於錯誤的包中，將其移動到正確的包。
   - 如果設計模式使用不當，重新設計以符合 DDD 原則。

## 常見架構違規及解決方案

### 1. 領域層依賴應用層

**問題**：領域模型不應該依賴應用服務。

**解決方案**：

- 將應用層邏輯移到應用服務中
- 使用領域事件進行通信
- 使用依賴倒置原則定義接口

### 2. 聚合根直接訪問其他聚合根

**問題**：聚合根應該通過ID引用其他聚合根，而不是直接引用。

**解決方案**：

- 使用ID引用其他聚合根
- 使用領域事件進行聚合間通信
- 使用領域服務協調多個聚合

### 3. 基礎設施關注點滲透到領域層

**問題**：領域模型不應該包含持久化或技術細節。

**解決方案**：

- 使用儲存庫模式隔離持久化邏輯
- 使用依賴倒置定義接口
- 將技術細節移到基礎設施層
